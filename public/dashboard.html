<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>

<div class="container mt-5">
    <h1>Bienvenido al sistema de registro</h1>
    <div id="message"></div>
    
    <button id="registerEntryBtn" class="btn btn-primary">Registro de Entrada</button>
    <button id="registerExitBtn" class="btn btn-warning">Registro de Salida</button>
    <button id="logoutBtn" class="btn btn-danger">Cerrar sesión</button>

    <div id="photoContainer" style="margin-top: 20px;">
        <h3>Foto Capturada</h3>
        <img id="capturedPhoto" src="" alt="Foto no capturada" style="width: 100%; max-width: 300px;">
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/face-api.js/0.22.2/face-api.min.js"></script>
<script>
    // Función para mostrar mensaje de carga
    function showLoadingMessage(message) {
        document.getElementById('message').innerHTML = `<div class="alert alert-info">${message}</div>`;
    }

    // Función para mostrar mensajes de error o éxito
    function showMessage(message, type = 'info') {
        document.getElementById('message').innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    }

    // Función para obtener la ubicación
    async function getLocation() {
        if (navigator.geolocation) {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 });
            });
        } else {
            throw new Error("La geolocalización no es soportada por este navegador.");
        }
    }

    // Función para capturar una foto
    async function capturePhoto() {
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");

        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
        const videoElement = document.createElement("video");
        videoElement.srcObject = stream;
        videoElement.play();

        await new Promise(resolve => videoElement.onloadedmetadata = resolve);
        canvas.width = videoElement.videoWidth;
        canvas.height = videoElement.videoHeight;

        context.drawImage(videoElement, 0, 0);
        const imageData = canvas.toDataURL("image/png");
        document.getElementById("capturedPhoto").src = imageData;

        // Detener el stream
        stream.getTracks().forEach(track => track.stop());
    }

    // Función para manejar el registro de entrada/salida
    async function handleRegister(endpoint) {
        try {
            showLoadingMessage('Obteniendo ubicación...');

            const position = await getLocation();
            const isWithinAllowedDistance = true;  // Aquí puedes agregar tu lógica de validación

            if (!isWithinAllowedDistance) {
                showMessage('Debe acercarse a la ubicación permitida para realizar el registro.', 'danger');
                return;
            }

            showLoadingMessage('Capturando foto...');
            await capturePhoto();

            const userId = 'usuario123';  // Reemplazar por la lógica de usuario actual
            const deviceID = localStorage.getItem('deviceID');

            // Enviar datos al servidor
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId, 
                    deviceID, 
                    ubicacion: { lat: position.coords.latitude, lng: position.coords.longitude }
                })
            });

            if (response.ok) {
                const data = await response.json();
                showMessage(data.msg, 'info');
            } else {
                throw new Error('Error al registrar la entrada/salida');
            }
        } catch (error) {
            showMessage(error.message, 'danger');
        }
    }

    // Función para cerrar sesión
    document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('deviceID');  // Limpiar los datos del dispositivo
        sessionStorage.clear();  // Limpiar cualquier otro dato de sesión si es necesario
        showMessage('Sesión cerrada con éxito.', 'success');
        window.location.href = '/login.html';  // Redirigir al login
    });

    // Event listeners para los botones de registro
    document.getElementById('registerEntryBtn').addEventListener('click', () => {
        handleRegister('/api/registro/entrada');  // Reemplazar con la URL de tu backend
    });

    document.getElementById('registerExitBtn').addEventListener('click', () => {
        handleRegister('/api/registro/salida');  // Reemplazar con la URL de tu backend
    });
</script>

</body>
</html>
