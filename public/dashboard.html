<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captura de Foto</title>
    <style>
        #capturedPhoto {
            max-width: 300px;
            max-height: 400px;
            border: 1px solid #ccc;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Registro de Entrada/Salida</h1>
    <video id="videoElement" width="320" height="240" autoplay></video>
    <button id="captureButton">Capturar Foto</button>
    <img id="capturedPhoto" src="" alt="Foto Capturada">
    <div id="message"></div>

    <script>
        // Función para obtener la ubicación del usuario
        async function getLocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(resolve, reject);
                } else {
                    reject(new Error("Geolocalización no es soportada por este navegador."));
                }
            });
        }

        // Función para mostrar la posición
        async function showPosition(position) {
            const allowedLocation = { lat: 4.653, lng: -74.099 }; // Ubicación permitida (ejemplo)
            const distance = calculateDistance(
                position.coords.latitude, position.coords.longitude,
                allowedLocation.lat, allowedLocation.lng
            );
            return distance < 100; // Permitido si está dentro de 100 metros
        }

        // Función para calcular la distancia entre dos puntos
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Radio de la Tierra en metros
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Resultado en metros
        }

        // Función para capturar la foto y agregar el texto
        async function capturePhoto(userName, userId) {
            const canvas = document.createElement("canvas");
            const context = canvas.getContext("2d");

            const videoElement = document.getElementById("videoElement");
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            videoElement.srcObject = stream;
            videoElement.play();

            await new Promise(resolve => videoElement.onloadedmetadata = resolve);
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;

            context.drawImage(videoElement, 0, 0);
            const imageData = canvas.toDataURL("image/png");

            // Agregar texto a la imagen
            context.font = "30px Arial";
            context.fillStyle = "white";
            context.fillText(`Usuario: ${userName}`, 20, 40); // Nombre del usuario
            context.fillText(`ID: ${userId}`, 20, 80); // ID del usuario
            context.fillText(`Fecha: ${new Date().toLocaleString()}`, 20, 120); // Fecha y hora

            document.getElementById("capturedPhoto").src = canvas.toDataURL("image/png");

            stream.getTracks().forEach(track => track.stop());
        }

        // Función para registrar la entrada o salida
        async function handleRegister(endpoint) {
            try {
                const position = await getLocation();
                const isWithinAllowedDistance = await showPosition(position);

                if (!isWithinAllowedDistance) {
                    document.getElementById('message').innerHTML = '<div class="alert alert-danger">Debe acercarse a la ubicación permitida para realizar el registro.</div>';
                    return;
                }

                // Supongamos que tienes el nombre y ID del usuario
                const userName = 'Iván'; // Aquí deberías tener el nombre real
                const userId = '123456'; // Aquí deberías tener el ID real

                // Captura la foto y agrega el texto
                await capturePhoto(userName, userId);

                // Guardar el registro en la base de datos (simulado)
                const deviceID = localStorage.getItem('deviceID');
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, deviceID, ubicacion: { lat: position.coords.latitude, lng: position.coords.longitude } }),
                });
                const data = await response.json();
                document.getElementById('message').innerHTML = `<div class="alert alert-info">${data.msg}</div>`;
            } catch (error) {
                document.getElementById('message').innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            }
        }

        // Evento para capturar la foto al presionar el botón
        document.getElementById("captureButton").addEventListener("click", function() {
            const endpoint = "/api/register"; // El endpoint donde guardarás los datos
            handleRegister(endpoint);
        });
    </script>
</body>
</html>
