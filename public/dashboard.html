<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reconocimiento Facial y Voz</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }
        #video {
            width: 100%;
            max-width: 200px;
            border: 2px solid black;
        }
        #canvas, #photo {
            display: none;
        }
        #takenPhoto, #photoValidation {
            width: 100%;
            max-width: 200px;
            border: 2px solid green;
            margin-top: 10px;
        }
        .btn {
            padding: 8px 16px;
            background-color: #28a745;
            color: white;
            font-size: 14px;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }
        .btn:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <h1>Reconocimiento Facial y Voz</h1>
    <video id="video" autoplay></video>
    <canvas id="canvas"></canvas>
    <img id="takenPhoto" src="" alt="Foto tomada" />
    <br />
    <button class="btn" id="takePhotoButton">Tomar Foto</button>
    <button class="btn" id="checkButton" style="display:none;">Verificar Foto</button>
    <br />
    <img id="photoValidation" src="" alt="Foto para verificación" />
    
    <script>
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const takenPhoto = document.getElementById("takenPhoto");
        const takePhotoButton = document.getElementById("takePhotoButton");
        const checkButton = document.getElementById("checkButton");
        const photoValidation = document.getElementById("photoValidation");

        let referenceImage = null;
        let currentImage = null;

        // Acceder a la cámara
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
            })
            .catch(err => {
                alert("No se pudo acceder a la cámara: " + err);
            });

        // Configurar el reconocimiento de voz
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = "es-ES";
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        // Función para empezar a escuchar
        recognition.onstart = () => {
            console.log("Escuchando...");
        };

        // Cuando se detecta una palabra
        recognition.onresult = (event) => {
            const command = event.results[0][0].transcript.toLowerCase();
            console.log("Comando recibido: ", command);

            // Si el comando es "foto", toma la foto
            if (command.includes("foto")) {
                capturePhoto();
            }
        };

        // Iniciar el reconocimiento de voz
        function startListening() {
            recognition.start();
        }

        // Capturar la foto
        function capturePhoto() {
            const context = canvas.getContext("2d");
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            const imgData = canvas.toDataURL("image/png");
            takenPhoto.src = imgData;
            takenPhoto.style.display = "block";

            // Si es la primera foto, la guardamos como referencia
            if (!referenceImage) {
                referenceImage = imgData;
                checkButton.style.display = "block"; // Mostrar el botón de verificación
                alert("Foto tomada como referencia. ¡Ahora toma una nueva foto para verificar!");
            } else {
                currentImage = imgData;
                photoValidation.src = currentImage;
                photoValidation.style.display = "block"; // Mostrar la foto de la nueva imagen
            }
        }

        // Tomar foto al hacer clic en el botón
        takePhotoButton.addEventListener("click", capturePhoto);

        // Verificar si la nueva foto coincide con la referencia
        checkButton.addEventListener("click", () => {
            if (!referenceImage) {
                alert("No se ha tomado ninguna foto de referencia.");
                return;
            }

            if (!currentImage) {
                alert("No se ha tomado una foto para comparar.");
                return;
            }

            if (compareImages(referenceImage, currentImage)) {
                alert("¡Es la misma persona!");
            } else {
                alert("No es la misma persona.");
            }
        });

        // Función para comparar dos imágenes (simplificada, por píxeles)
        function compareImages(img1, img2) {
            const canvas1 = document.createElement("canvas");
            const canvas2 = document.createElement("canvas");

            const imgElement1 = new Image();
            const imgElement2 = new Image();

            imgElement1.src = img1;
            imgElement2.src = img2;

            // Esperamos a que ambas imágenes estén cargadas
            imgElement1.onload = () => {
                imgElement2.onload = () => {
                    canvas1.width = imgElement1.width;
                    canvas1.height = imgElement1.height;
                    canvas2.width = imgElement2.width;
                    canvas2.height = imgElement2.height;

                    canvas1.getContext("2d").drawImage(imgElement1, 0, 0);
                    canvas2.getContext("2d").drawImage(imgElement2, 0, 0);

                    const data1 = canvas1.getContext("2d").getImageData(0, 0, canvas1.width, canvas1.height);
                    const data2 = canvas2.getContext("2d").getImageData(0, 0, canvas2.width, canvas2.height);

                    let diff = 0;
                    const length = data1.data.length;

                    for (let i = 0; i < length; i += 4) {
                        const r1 = data1.data[i];
                        const g1 = data1.data[i + 1];
                        const b1 = data1.data[i + 2];

                        const r2 = data2.data[i];
                        const g2 = data2.data[i + 1];
                        const b2 = data2.data[i + 2];

                        diff += Math.abs(r1 - r2) + Math.abs(g1 - g2) + Math.abs(b1 - b2);
                    }

                    // Umbral de tolerancia de diferencia
                    const threshold = 100000; // Puedes ajustar este valor
                    if (diff < threshold) {
                        return true; // Las imágenes son similares
                    } else {
                        return false; // Las imágenes no son similares
                    }
                };
            };
        }

        // Iniciar escucha cuando la página cargue
        window.onload = () => {
            startListening();
        };
    </script>
</body>
</html>
