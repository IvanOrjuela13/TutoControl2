<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captura Automática de Foto</title>
    <style>
        #video, #canvas {
            display: block;
            margin: 10px auto;
            border: 2px solid black;
            max-width: 90%;
        }
        #takenPhoto {
            display: block;
            margin: 20px auto;
            max-width: 90%;
        }
    </style>
</head>
<body>
    <h1 style="text-align: center;">Captura Automática de Foto</h1>
    <video id="video" autoplay></video>
    <canvas id="canvas" style="display: none;"></canvas>
    <img id="takenPhoto" alt="Foto tomada aparecerá aquí" />

    <script>
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const takenPhoto = document.getElementById("takenPhoto");
        const context = canvas.getContext("2d");

        let photoCaptured = false; // Flag para saber si ya se tomó la foto
        let timer = null; // Para el temporizador de un minuto
        let previousFrame = null; // Para comparar frames consecutivos

        // Acceder a la cámara
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
                video.addEventListener("play", startDetection);
            })
            .catch(err => {
                alert("No se pudo acceder a la cámara: " + err);
            });

        // Iniciar el temporizador de un minuto
        function startTimer() {
            timer = setTimeout(() => {
                if (!photoCaptured) {
                    alert("Tiempo agotado. No se detectó actividad.");
                }
            }, 60000); // 60 segundos
        }

        // Iniciar detección de movimiento
        function startDetection() {
            startTimer(); // Iniciar el temporizador de un minuto
            detectMotion();
        }

        function detectMotion() {
            if (photoCaptured) return; // Detener si ya se tomó la foto

            // Dibujar el frame actual en el canvas
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            const currentFrame = context.getImageData(0, 0, canvas.width, canvas.height);

            // Comparar con el frame anterior para detectar cambios
            if (previousFrame) {
                const motionDetected = compareFrames(previousFrame.data, currentFrame.data);
                if (motionDetected) {
                    capturePhoto(); // Tomar la foto si se detecta movimiento
                    return;
                }
            }

            // Guardar el frame actual como referencia para la próxima comparación
            previousFrame = currentFrame;

            // Continuar detectando en el siguiente frame
            requestAnimationFrame(detectMotion);
        }

        // Comparar dos frames
        function compareFrames(frame1, frame2) {
            let diff = 0;

            // Comparar cada píxel (canales R, G, B)
            for (let i = 0; i < frame1.length; i += 4) {
                diff += Math.abs(frame1[i] - frame2[i]);     // Canal Rojo
                diff += Math.abs(frame1[i + 1] - frame2[i + 1]); // Canal Verde
                diff += Math.abs(frame1[i + 2] - frame2[i + 2]); // Canal Azul
            }

            // Calcular un umbral para detectar movimiento
            const averageDiff = diff / (frame1.length / 4);
            return averageDiff > 20; // Ajustar umbral según sensibilidad
        }

        // Capturar la foto
        function capturePhoto() {
            if (photoCaptured) return; // Evitar capturas múltiples

            // Dibujar el frame actual en el canvas y generar la foto
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const photo = canvas.toDataURL("image/png");

            // Mostrar la foto capturada
            takenPhoto.src = photo;
            photoCaptured = true;

            alert("Foto tomada automáticamente.");
            clearTimeout(timer); // Detener el temporizador
        }
    </script>
</body>
</html>
