<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inicio de Usuario</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
</head>
<body class="bg-light">

  <div class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header text-center bg-primary text-white">
            <h3>Iniciar Sesión</h3>
          </div>
          <div class="card-body">
            <form id="loginForm">
              <div class="mb-3">
                <label for="cedula" class="form-label">Cédula</label>
                <input type="text" class="form-control" id="cedula" placeholder="Ingresa tu cédula" required>
              </div>
              <div class="mb-3">
                <label for="password" class="form-label">Contraseña</label>
                <input type="password" class="form-control" id="password" placeholder="Ingresa tu contraseña" required>
              </div>
              <button type="submit" class="btn btn-primary w-100">Iniciar Sesión</button>
            </form>
            <div id="message" class="mt-3"></div>
            <div class="text-center mt-2">
              <a href="#" data-bs-toggle="modal" data-bs-target="#resetPasswordModal">¿Olvidaste tu contraseña?</a>
            </div>
          </div>
          <div class="card-footer text-center">
            <p>¿No tienes una cuenta? <a href="register.html">Regístrate aquí</a></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para restablecer contraseña -->
  <div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="resetPasswordModalLabel">Restablecer Contraseña</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p>Ingresa tu cédula y una nueva contraseña.</p>
          <form id="resetPasswordForm">
            <div class="mb-3">
              <label for="resetCedula" class="form-label">Cédula</label>
              <input type="text" class="form-control" id="resetCedula" placeholder="Ingresa tu cédula" required>
            </div>
            <div class="mb-3">
              <label for="newPassword" class="form-label">Nueva Contraseña</label>
              <input type="password" class="form-control" id="newPassword" placeholder="Ingresa tu nueva contraseña" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Actualizar Contraseña</button>
          </form>
          <div id="resetMessage" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Funciones para manejar cookies
    function setCookie(name, value, days) {
      let expires = "";
      if (days) {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000)); 
        expires = "; expires=" + date.toUTCString();
      }
      document.cookie = name + "=" + encodeURIComponent(value) + "; path=/" + expires;
    }

    function getCookie(name) {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + "=")) {
          return decodeURIComponent(cookie.substring(name.length + 1));
        }
      }
      return null;
    }

    // Recuperar el deviceID del localStorage o de las cookies; si no existe, se crea uno nuevo.
    let deviceID = localStorage.getItem('deviceID') || getCookie('deviceID');
    if (!deviceID) {
      deviceID = 'device-' + Date.now();
      localStorage.setItem('deviceID', deviceID); 
      setCookie('deviceID', deviceID, 360);
    }
    console.log("deviceID que se envía:", deviceID);

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const cedula = document.getElementById('cedula').value;
      const password = document.getElementById('password').value;

      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ cedula, password, deviceID }),
        });

        const data = await response.json();
        const messageDiv = document.getElementById('message');

        if (response.ok) {
          // Almacenar los datos en localStorage y en cookies
          localStorage.setItem('cedula', cedula);
          localStorage.setItem('token', data.token);
          setCookie('cedula', cedula, 360);
          setCookie('token', data.token, 360);

          // Almacenar "username" (usando el valor retornado por el API o la cédula como fallback)
          if (data.username) {
            localStorage.setItem('username', data.username);
            setCookie('username', data.username, 360);
          } else {
            localStorage.setItem('username', cedula);
            setCookie('username', cedula, 360);
          }

          messageDiv.innerHTML = `<div class="alert alert-success">${data.msg}</div>`;
          window.location.href = '/dashboard.html'; 
        } else {
          messageDiv.innerHTML = `<div class="alert alert-danger">${data.msg}</div>`;
        }
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('message').innerHTML = `<div class="alert alert-danger">Error en el servidor</div>`;
      }
    });

    document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const cedula = document.getElementById('resetCedula').value;
      const newPassword = document.getElementById('newPassword').value;

      try {
        const response = await fetch('/api/auth/reset-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ cedula, newPassword }),
        });

        const data = await response.json();
        const resetMessageDiv = document.getElementById('resetMessage');

        if (response.ok) {
          resetMessageDiv.innerHTML = `<div class="alert alert-success">${data.msg}</div>`;
        } else {
          resetMessageDiv.innerHTML = `<div class="alert alert-danger">${data.msg}</div>`;
        }
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('resetMessage').innerHTML = `<div class="alert alert-danger">Error en el servidor</div>`;
      }
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
</body>
</html>
