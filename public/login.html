<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio de Usuario</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
</head>
<body class="bg-light">

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header text-center bg-primary text-white">
                    <h3>Iniciar Sesión</h3>
                </div>
                <div class="card-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="cedula" class="form-label">Cédula</label>
                            <input type="text" class="form-control" id="cedula" placeholder="Ingresa tu cédula" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Contraseña</label>
                            <input type="password" class="form-control" id="password" placeholder="Ingresa tu contraseña" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Iniciar Sesión</button>
                    </form>
                    <div id="message" class="mt-3"></div>
                    <div class="text-center mt-2">
                        <a href="#" data-bs-toggle="modal" data-bs-target="#resetPasswordModal">¿Olvidaste tu contraseña?</a>
                    </div>
                    <div class="text-center mt-3">
                        <!-- Enlace a la página de registro -->
                        <a href="/register" class="btn btn-secondary w-100">Registrarse</a>
                    </div>
                    <div class="text-center mt-3">
                        <button id="recoverAccountBtn" class="btn btn-secondary w-100">Recuperar Actividad de Cuenta</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para restablecer contraseña -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resetPasswordModalLabel">Restablecer Contraseña</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <p>Ingresa tu cédula y una nueva contraseña.</p>
                <form id="resetPasswordForm">
                    <div class="mb-3">
                        <label for="resetCedula" class="form-label">Cédula</label>
                        <input type="text" class="form-control" id="resetCedula" placeholder="Ingresa tu cédula" required>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">Nueva Contraseña</label>
                        <input type="password" class="form-control" id="newPassword" placeholder="Ingresa tu nueva contraseña" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Actualizar Contraseña</button>
                </form>
                <div id="resetMessage" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // Manejo de inicio de sesión
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const cedula = document.getElementById('cedula').value;
        const password = document.getElementById('password').value;

        try {
            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cedula, password })
            });

            const data = await response.json();
            const messageDiv = document.getElementById('message');

            if (response.ok) {
                localStorage.setItem('token', data.token);
                window.location.href = '/dashboard.html';
            } else {
                messageDiv.innerHTML = `<div class="alert alert-danger">${data.msg}</div>`;
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('message').innerHTML = `<div class="alert alert-danger">Error en el servidor</div>`;
        }
    });

    // Manejo de recuperación de cuenta
    document.getElementById('recoverAccountBtn').addEventListener('click', () => {
        // Mostrar una nueva sección para ingresar la Cédula
        const recoverSection = document.createElement('div');
        recoverSection.innerHTML = `
            <div class="mb-3">
                <label for="recoverCedula" class="form-label">Cédula</label>
                <input type="text" class="form-control" id="recoverCedula" placeholder="Ingresa tu cédula" required>
            </div>
            <button id="sendSecurityCode" class="btn btn-primary w-100">Enviar Código de Seguridad</button>
            <div id="recoverMessage" class="mt-3"></div>
        `;
        document.getElementById('recoverAccountBtn').style.display = 'none';
        document.getElementById('loginForm').appendChild(recoverSection);

        // Enviar la cédula para generar el código de seguridad
        document.getElementById('sendSecurityCode').addEventListener('click', async () => {
            const cedula = document.getElementById('recoverCedula').value;

            try {
                const response = await fetch('/api/auth/recover-activity', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cedula })
                });

                const data = await response.json();
                const messageDiv = document.getElementById('recoverMessage');

                if (response.ok) {
                    messageDiv.innerHTML = `<div class="alert alert-success">${data.msg}</div>`;
                    const codeInput = document.createElement('input');
                    codeInput.id = 'securityCode';
                    codeInput.classList.add('form-control');
                    codeInput.placeholder = 'Ingresa el código de seguridad';
                    document.getElementById('recoverMessage').appendChild(codeInput);

                    const verifyButton = document.createElement('button');
                    verifyButton.textContent = 'Verificar Código';
                    verifyButton.classList.add('btn', 'btn-success', 'w-100');
                    document.getElementById('recoverMessage').appendChild(verifyButton);

                    // Verificar el código de seguridad ingresado
                    verifyButton.addEventListener('click', async () => {
                        const securityCode = document.getElementById('securityCode').value;

                        const verifyResponse = await fetch('/api/auth/verify-security-code', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ cedula, securityCode })
                        });

                        const verifyData = await verifyResponse.json();

                        if (verifyResponse.ok) {
                            messageDiv.innerHTML = `<div class="alert alert-success">${verifyData.msg}</div>`;
                            window.location.href = '/dashboard.html';  // Redirige al usuario
                        } else {
                            messageDiv.innerHTML = `<div class="alert alert-danger">${verifyData.msg}</div>`;
                        }
                    });
                } else {
                    messageDiv.innerHTML = `<div class="alert alert-danger">${data.msg}</div>`;
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('recoverMessage').innerHTML = `<div class="alert alert-danger">Error en el servidor</div>`;
            }
        });
    });
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
</body>
</html>
